<div id="main" class="container">
  <div id="scroll">
    <div id="booking" class="container">
      <div class="row-fluid" id="res_info">
        <div class="span5">
          <div id="pics">
            <!-- 這邊換成圖片 -->
            <% 4.times do %>
                <div></div>
            <% end %>
          </div>
          <!-- 這邊是封面 id保留 -->
          <div id="main_pic"></div>
        </div>
        <div class="span7">
          <table>
            <tr>
              <td>餐廳名稱：</td>
              <td><%= @restaurant.name %></td>
            </tr>
            <tr>
              <td>餐廳地址：</td>
              <td><%= @restaurant.city + @restaurant.area + @restaurant.address %></td>
            </tr>
            <tr>
              <td>餐廳電話：</td>
              <td><%= @restaurant.phone %></td>
            </tr>
            <tr>
              <td>餐廳特色：</td>
              <td><%= @restaurant.feature %></td>
            </tr>
            <tr>
              <td>營業時間：</td>
              <td><%= @restaurant.business_hours %></td>
            </tr>
            <tr>
              <td>付款方式：</td>
              <td>
                <% if @restaurant.pay_type.include?('1') %>
                    現金
                <% end %>

                <% if @restaurant.pay_type.include?('2') %>
                    信用卡
                <% end %>

                <% if @restaurant.pay_type.include?('3') %>
                    悠遊卡
                <% end %>
              </td>
            </tr>
            <tr>
              <td>餐廳網址：</td>
              <td>
                <a href="<%= @restaurant.url1 %>" target="_blank"><%= @restaurant.info_url1 %></a>、
                <a href="<%= @restaurant.url2 %>" target="_blank"><%= @restaurant.info_url2 %></a>、
                <a href="<%= @restaurant.url3 %>" target="_blank"><%= @restaurant.info_url3 %></a>
              </td>
            </tr>
          </table>
        </div>
      </div>
        <div class="row-fluid" id="booking_form_content">
          <div class="span12" style="background-color: rgb(230,230,230)">
            步驟一 => 步驟二
          </div>
          <div class="row-fluid">
            <form action="home/save_booking" id="booking_form" method="post">

              <div class="span6" id="get_info">

                <%= render :partial => 'booking_zone', :locals => {:booking_condition => @booking_condition}  %>
              </div>
              <div class="span6">
                <table>
                  <tr>
                    <td>訂位者大名：</td>
                    <td><input type="text" name="booker_name" value="<%= @booker.name %>"></td>
                  </tr>
                  <tr>
                    <td>訂位者電話：</td>
                    <td><input type="text" name="booker_phone" value="<%= @booker.phone %>"></td>
                  </tr>
                  <tr>
                    <td>訂位E-mail：</td>
                    <td><input type="text" name="booker_email" value="<%= @booker.email %>"></td>
                  </tr>
                  <tr>
                    <td colspan="2"><textarea style="width: 100%" placeholder="留言給餐廳" name="remark"></textarea></td>
                  </tr>
                  <tr>
                    <td colspan="2">
                      <input type="submit" value="送出" class="btn btn-primary">
                      <input type="reset" value="取消" class="btn">
                    </td>
                  </tr>
                </table>
              </div>
            </form>
          </div>
        </div>
    </div>

    <div id="finish" class="container">
      <h2>訂位成功</h2>
      我們已收到您的訂位，會以E-mail方式提醒您。<br>
      謝謝您使用訂吧提供的訂位服務。
      <div class="base_orange">
        <span style="font-size: 24px">前往步驟 2</span>
        <span style="line-height: 24px; vertical-align: bottom;">通知好友訂位資訊</span>
      </div>
      <input type="button" value="前往通知" class="btn btn-primary" id="go_notice">
      <input type="button" value="不用，謝謝" class="btn close_window">


    </div>

    <div id="to_friend" class="container">
      <form action="padding_url" id="to_friend_form">
        直接輸入E-mail, 並以”,”區分不同收件者
        <input type="text" name="">
        <input type="submit" value="通知好友" class="btn btn-primary">
      </form>
    </div>

    <div id="thanks" class="container">
      <h3>您已成功通知好友訂位資訊！</h3>
      <h3>謝謝您使用 訂吧 提供的訂位服務。</h3>
      if not login
      註冊帳號可享維護訂位記錄、極速訂位等服務。
      我要註冊 訂吧 帳號
      end
    </div>
  </div>
</div>

<div id="lightbox">
  <img class="content" src="/assets/booker/blog.jpg" alt="">
</div>


<script>
    $("#booking_date").datepicker({
        dateFormat: 'yy-mm-dd',
        changeMonth: true
    }).val(getTodaysDate()); // For current date;

    function getTodaysDate () {
        var t = new Date;
        var year = t.getFullYear();
        var day = t.getDate()
        if (day < 10) {day = '0' + day;}

        var month = t.getMonth() + 1;
        if ( month < 10){month = '0' + month;}

        return (year + '-' + month + '-' + day);
    }

    $(window).ready(function(){
        bind_event();
    });

    function bind_event(){
        $("#booking_date").live("click", function(){
            $("#booking_date").datepicker({
                dateFormat: 'yy-mm-dd',
                changeMonth: true,
                showOn:'focus'
            }).focus();
        });

        $('#select_people').live('change', function(){
            var num_of_people = $(this).val();
            show_zone(num_of_people)
        });

        $('#select_zone').live('change', function(){
            var zone_id = $(this).val();
            var num_of_people = $('#select_people').val();
            set_time_button(zone_id, num_of_people);
        });
    }

    $("#booking_date").change(function(){
        //e.preventDefault()

        $.ajax({
            url: "/home/get_condition",
            type: 'get',
            data: {booking_day: this.value, id: location.href.split('/').pop()},
            cache: false,
            async: false,
            success: function(response){
                if (response.success) {
                    $('#get_info').html($.parseHTML(response.attachmentPartial))
                    //$('#get_info').html($.parseHTML(response.attachmentPartial))
                    //instance var jquey area can't reload
                    var num_of_people = '1'
                    $('#select_people').val(num_of_people)
                    show_zone(num_of_people)
                }
                else if (response.error)
                    alert(response.message)
                else
                    alert('發生未預期的回應，請告知CoDream小組處理!')
            },
            error: function(){
                alert('oops! 出現錯誤了!');
            }
        });
    });

    $(function(){
        var num_of_people = '1'
        $('#select_people').val(num_of_people)
        show_zone(num_of_people)
    });

    $('#booking_form').submit(function(e){
        e.preventDefault()

        var booker_data = $(this).serializeArray();
        var booking = {};

        for(item in booker_data){
            booking[booker_data[item]['name']] = booker_data[item]['value']
        }

        var no_select = true
        $(".btn.checked").each(function(){
            no_select = false
            booking['booking_time'] = $("#booking_date").val() + " " + $(this).val() ;
            booking['time_zone_id'] = $(".btn.checked").data('value')
        });

        if (no_select) {
            alert("訂位時間還沒有選擇喔~!")
            return false
        }
        //JSON.stringify(booking)
        //alert(booking)

        $.ajax({
            url: "/home/save_booking",
            type: 'POST',
            data:  {booking: $.parseJSON(JSON.stringify(booking))},
            cache: false,
            async: false,
            success: function(response){
                if (response.success)
                    alert(response.data)
                else if (response.error)
                    alert(response.message)
                else
                    alert('發生未預期的回應，請告知CoDream小組處理!')
            },
            error: function(){
                alert('oops! 出現錯誤了!');
            }
        });
    });


    function show_zone(num_of_people){
        $('#select_zone').empty();

        var zone_id = null
        <% if @booking_condition.error != true %>
            <% @booking_condition.option_of_people.each do |ofp| %>
            if ('<%= ofp[0] %>' >= num_of_people) {
                $("#select_zone").append(new Option('<%= ofp[2] %>', '<%= ofp[1] %>'))

                if (zone_id == null)
                    zone_id = '<%= ofp[1] %>';
            }
            <% end %>
        <% end %>

        if (zone_id != null){
            set_time_button(zone_id, num_of_people);
        }
    };

    function set_time_button(zone_id, num_of_people){
        $('#time_select').empty();

        <% if @booking_condition.error != true %>
            <% @booking_condition.option_of_time.each do |oft| %>

            if ('<%= oft[0] %>' == zone_id){

                if ((parseInt('<%= oft[3] %>') + parseInt(num_of_people)) > parseInt('<%= oft[2] %>')) {
                    <% (oft.length - 4).times do |i| %>
                        var btn = $("<input type=\"button\"  value=\"" + '<%= oft[i + 4][1] %>' + "\" data-value=\"" + '<%= oft[0] %>' + "\" class=\"btn btn-inverse\" />");
                        $("#time_select").append(btn)
                    <% end %>
                    return
                }
                else {
                    <% (oft.length - 4).times do |i| %>

                        if ((parseInt('<%= oft[i + 4][2] %>') + parseInt(num_of_people)) > parseInt('<%= oft[1] %>')){
                            var btn = $("<input type=\"button\"  value=\"" + '<%= oft[i + 4][1] %>' + "\" data-value=\"" + '<%= oft[0] %>' + "\" class=\"btn btn-inverse\" />");
                            $("#time_select").append(btn)
                        }
                        else if ('<%= oft[i + 4][0]%>' == 0) {
                            var btn = $("<input type=\"button\"  value=\"" + '<%= oft[i + 4][1] %>' + "\" data-value=\"" + '<%= oft[0] %>' + "\" class=\"btn\" />");
                            $("#time_select").append(btn)
                        }else if ('<%= oft[i + 4][0]%>' == 1) {
                            var btn = $("<input type=\"button\"  value=\"" + '<%= oft[i + 4][1] %>' + "\" data-value=\"" + '<%= oft[0] %>' + "\"class=\"btn btn-inverse\" />");
                            $("#time_select").append(btn)
                        }

                    <% end %>
                    return
                }
            }
            <% end %>
        <% end %>
    };

</script>

